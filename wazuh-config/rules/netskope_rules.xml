<!-- Netskope Integration Rules -->
<group name="netskope,">

  <!-- Base rule for Netskope events -->
  <rule id="100100" level="3">
    <decoded_as>json</decoded_as>
    <field name="netskope">\.+</field>
    <description>Netskope event</description>
    <group>netskope</group>
  </rule>

  <!-- Client Status Rules -->
  <rule id="100101" level="5">
    <if_sid>100100</if_sid>
    <field name="netskope">client_status</field>
    <field name="event_type">client_status</field>
    <description>Netskope client status event</description>
    <group>netskope,client_status</group>
  </rule>

  <!-- Client Disconnected -->
  <rule id="100102" level="8">
    <if_sid>100101</if_sid>
    <field name="client_status">disconnected|offline|down</field>
    <description>Netskope client disconnected - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,disconnected</group>
  </rule>

  <!-- Client Uninstalled -->
  <rule id="100103" level="10">
    <if_sid>100101</if_sid>
    <field name="event_subtype">uninstall|removed</field>
    <description>Netskope client uninstalled - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,uninstalled</group>
  </rule>

  <!-- Client Connection Lost -->
  <rule id="100104" level="7">
    <if_sid>100101</if_sid>
    <field name="tunnel_status">down|disconnected</field>
    <description>Netskope client tunnel down - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,tunnel_down</group>
  </rule>

  <!-- Client Installation Failed -->
  <rule id="100105" level="9">
    <if_sid>100101</if_sid>
    <field name="installation_status">failed|error</field>
    <description>Netskope client installation failed - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,installation_failed</group>
  </rule>

  <!-- Client Upgrade Failed -->
  <rule id="100106" level="8">
    <if_sid>100101</if_sid>
    <field name="upgrade_status">failed|error</field>
    <description>Netskope client upgrade failed - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,upgrade_failed</group>
  </rule>

  <!-- Client Disabled by User -->
  <rule id="100107" level="8">
    <if_sid>100101</if_sid>
    <field name="client_action">disabled|stopped</field>
    <field name="initiated_by">user</field>
    <description>Netskope client disabled by user - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,user_disabled</group>
  </rule>

  <!-- Client Policy Violation -->
  <rule id="100108" level="9">
    <if_sid>100101</if_sid>
    <field name="policy_violation">true</field>
    <description>Netskope client policy violation - $(hostname) - User: $(user) - Policy: $(policy_name)</description>
    <group>netskope,client_status,policy_violation</group>
  </rule>

  <!-- Client Authentication Issues -->
  <rule id="100109" level="8">
    <if_sid>100101</if_sid>
    <field name="auth_status">failed|error</field>
    <description>Netskope client authentication failed - $(hostname) - User: $(user)</description>
    <group>netskope,client_status,auth_failed</group>
  </rule>

  <!-- Client Version Mismatch -->
  <rule id="100110" level="6">
    <if_sid>100101</if_sid>
    <field name="version_status">outdated|mismatch</field>
    <description>Netskope client version outdated - $(hostname) - User: $(user) - Version: $(client_version)</description>
    <group>netskope,client_status,version_outdated</group>
  </rule>

  <!-- Multiple Failures Correlation -->
  <rule id="100111" level="12" frequency="3" timeframe="300">
    <if_matched_sid>100102</if_matched_sid>
    <same_field>hostname</same_field>
    <description>Multiple Netskope client disconnections from same host - $(hostname)</description>
    <group>netskope,client_status,multiple_failures</group>
  </rule>

  <!-- Client Events Rules -->
  <rule id="100120" level="4">
    <if_sid>100100</if_sid>
    <field name="netskope">client_events</field>
    <field name="event_type">client_event</field>
    <description>Netskope client event</description>
    <group>netskope,client_events</group>
  </rule>

  <!-- Client Startup -->
  <rule id="100121" level="3">
    <if_sid>100120</if_sid>
    <field name="event_subtype">startup|started|connected</field>
    <description>Netskope client started - $(hostname) - User: $(user)</description>
    <group>netskope,client_events,startup</group>
  </rule>

  <!-- Client Shutdown -->
  <rule id="100122" level="5">
    <if_sid>100120</if_sid>
    <field name="event_subtype">shutdown|stopped</field>
    <description>Netskope client stopped - $(hostname) - User: $(user)</description>
    <group>netskope,client_events,shutdown</group>
  </rule>

  <!-- Alert Rules -->
  <rule id="100140" level="6">
    <if_sid>100100</if_sid>
    <field name="netskope">alerts</field>
    <field name="event_type">alert</field>
    <description>Netskope alert event</description>
    <group>netskope,alerts</group>
  </rule>

  <!-- High Severity Alerts -->
  <rule id="100141" level="10">
    <if_sid>100140</if_sid>
    <field name="alert_type">malware|dlp|anomaly</field>
    <description>Netskope high severity alert - Type: $(alert_type) - User: $(user) - Host: $(hostname)</description>
    <group>netskope,alerts,high_severity</group>
  </rule>

  <!-- Policy Alerts -->
  <rule id="100142" level="8">
    <if_sid>100140</if_sid>
    <field name="alert_type">policy</field>
    <description>Netskope policy alert - Policy: $(policy_name) - User: $(user) - Host: $(hostname)</description>
    <group>netskope,alerts,policy</group>
  </rule>

  <!-- Integration Health Rules -->
  <rule id="100200" level="3">
    <program_name>netskope-integration</program_name>
    <description>Netskope integration log</description>
    <group>netskope,integration</group>
  </rule>

  <!-- Integration Error -->
  <rule id="100201" level="8">
    <if_sid>100200</if_sid>
    <match>ERROR|Failed|Exception</match>
    <description>Netskope integration error: $(log)</description>
    <group>netskope,integration,error</group>
  </rule>

  <!-- Integration Warning -->
  <rule id="100202" level="5">
    <if_sid>100200</if_sid>
    <match>WARNING|WARN</match>
    <description>Netskope integration warning: $(log)</description>
    <group>netskope,integration,warning</group>
  </rule>

  <!-- API Rate Limit -->
  <rule id="100203" level="7">
    <if_sid>100200</if_sid>
    <match>rate limit|429|too many requests</match>
    <description>Netskope API rate limit reached</description>
    <group>netskope,integration,rate_limit</group>
  </rule>

</group>